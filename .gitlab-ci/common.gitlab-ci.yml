cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/

variables:
  # Azure
  ARM_CLIENT_ID: $ARM_CLIENT_ID
  ARM_CLIENT_SECRET: $ARM_CLIENT_SECRET
  ARM_SUBSCRIPTION_ID: $ARM_SUBSCRIPTION_ID
  ARM_TENANT_ID: $ARM_TENANT_ID
  ARM_RESOURCE_GROUP_NAME: $ARM_RESOURCE_GROUP_NAME

  ARM_WEB_APP_SERVICE_NAME: $ARM_WEB_APP_SERVICE_NAME
  ARM_WEB_APP_SERVICE_PLAN_NAME: $ARM_WEB_APP_SERVICE_PLAN_NAME

  WEB_ASP_SKU: $TF_VAR_web_asp_sku
  WEB_ASP_DEPLOYMENT_TARGET_SKU: $WEB_ASP_DEPLOYMENT_TARGET_SKU

  # Terraform
  TF_ROOT: $CI_PROJECT_DIR/terraform
  TF_CLI_CONFIG_FILE: $CI_PROJECT_DIR/terraform/.terraformrc
  TFSTATE_STORAGE_ACCOUNT_NAME: $TFSTATE_STORAGE_ACCOUNT_NAME
  TFSTATE_RESOURCE_GROUP_NAME: $TFSTATE_RESOURCE_GROUP_NAME
  TFSTATE_CONTAINER_NAME: $TFSTATE_CONTAINER_NAME

  # Versioning
  GITLAB_TOKEN: $GITLAB_TOKEN

  # Application
  INCLUDE_NODE_MODULES_IN_ZIP: $INCLUDE_NODE_MODULES_IN_ZIP
  LOAD_MESSAGES_LOCALLY: $LOAD_MESSAGES_LOCALLY
  WEB_REINITIALIZE_INTL_URL: $WEB_REINITIALIZE_INTL_URL

  # Proxy
  NO_PROXY: $NO_PROXY,privatelink.azurewebsites.net,scm.azurewebsites.net,ae-solarassista-qa-api.azurewebsites.net,ae-solarassista-qa-web.azurewebsites.net,ae-solarassista-qa-web.scm.azurewebsites.net,ae-solarassista-prod-api.azurewebsites.net,ae-solarassista-prod-web.azurewebsites.net,privatelink.snowflakecomputing.com,gitlabp2.alliant-energy.com,z22.web.core.windows.net,stsolarassistaqacus.blob.core.windows.net,privatelink.blob.core.windows.net,stsolarassistaprodcus.blob.core.windows.net,solarassista-qa.alliantenergy.com,solarassista.alliantenergy.com,func-solarassista-qa-cus.azurewebsites.net,applicantassist.alliantenergy.com,applicantassist-api.alliantenergy.com,applicantassist-qa.alliantenergy.com,dgassist-qa.alliantenergy.com,dgassist.alliantenergy.com,,applicantassist-api-qa.alliantenergy.com,dgassist-api-qa.alliantenergy.com,dgassist-api.alliantenergy.com
  no_proxy: $NO_PROXY,privatelink.azurewebsites.net,scm.azurewebsites.net,ae-solarassista-qa-api.azurewebsites.net,ae-solarassista-qa-web.azurewebsites.net,ae-solarassista-qa-web.scm.azurewebsites.net,ae-solarassista-prod-api.azurewebsites.net,ae-solarassista-prod-web.azurewebsites.net,privatelink.snowflakecomputing.com,gitlabp2.alliant-energy.com,z22.web.core.windows.net,stsolarassistaqacus.blob.core.windows.net,privatelink.blob.core.windows.net,stsolarassistaprodcus.blob.core.windows.net,solarassista-qa.alliantenergy.com,solarassista.alliantenergy.com,func-solarassista-qa-cus.azurewebsites.net,applicantassist.alliantenergy.com,applicantassist-api.alliantenergy.com,applicantassist-qa.alliantenergy.com,dgassist-qa.alliantenergy.com,dgassist.alliantenergy.com,,applicantassist-api-qa.alliantenergy.com,dgassist-api-qa.alliantenergy.com,dgassist-api.alliantenergy.com

stages:
  - .pre
  - build
  # - test
  # - predeploy
  # - deploy
  # - postdeploy
  # - release

.npm_default:
  image: gitlabp2.alliant-energy.com:5050/devops/gitlab-ci-images/ae-node-18:18
  before_script:
    - echo "Node version " $(node --version)
    - echo "NPM version " $(npm --version)
    - echo "App build version " $APP_VERSION

.tf_default:
  image: gitlabp2.alliant-energy.com:5050/cloud/gitlab-ci-images/ae-terraform:latest
  before_script:
    - echo "Terraform version " $(terraform --version)
    - echo "App build version " $APP_VERSION
    - echo -e "credentials \"$CI_SERVER_HOST\" {\n  token = \"$CI_JOB_TOKEN\"\n}" > $TF_CLI_CONFIG_FILE
    - cd ${TF_ROOT}
    - echo -e "Gitlab Project Environment\n--------------------------"
    - echo "$CI_ENVIRONMENT_NAME"
    - echo -e "Azure Environment Variables\n--------------------------"
    - env | grep '^ARM\|^TFSTATE'

.azcli_default:
  image: gitlabp2.alliant-energy.com:5050/cloud/gitlab-ci-images/ae-azurecli:latest
  before_script:
    - echo "Azure CLI version " $(az --version)
    - echo "App build version " $APP_VERSION
